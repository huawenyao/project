# Feature Specification: AI思考过程可视化系统

**Feature Branch**: `002-ai-thinking-visualization`
**Created**: 2025-10-27
**Status**: Draft
**Input**: User description: "AI思考过程可视化系统:让用户实时看到AI Agent的工作状态、决策推理和协作过程,提供透明、可感知的产品体验。包括进度可视化、决策卡片弹出、Agent拟人化交互、实时影响预测等核心功能,打造新颖有趣的用户体验。"

## Clarifications

### Session 2025-10-27

- Q: WebSocket 实时更新频率和数据粒度策略 - 在 AI 编程产品中，实时可视化的流畅度直接影响用户对系统"智能感"的感知。应该采用统一高频、统一中频、混合策略还是自适应策略？ → A: 混合策略 - 根据Agent重要性和事件类型动态调整更新频率（关键Agent如UIAgent/BackendAgent采用200-500ms高频更新，辅助Agent如DeploymentAgent采用1-2s低频更新）
- Q: 可视化界面的设计美学方向 - 设计美学直接影响用户对"AI智能感"和"团队协作感"的感知。应该采用简约专业风、科技未来感、温暖友好风还是极客技术风？ → A: 温暖友好风(C)为默认设计主题，同时支持用户切换到科技未来感(B)主题 - 默认使用明亮色彩、圆角卡片、趣味插画、跳跃动画降低技术门槛，为技术用户提供深色背景、霓虹色点缀、流畅粒子动画的科技感主题
- Q: 决策记录的存储策略和访问模式 - 数据生命周期管理策略直接影响存储成本、查询性能和用户体验。应该全量实时存储、热数据+冷存储、滚动窗口还是用户分级策略？ → A: 热数据 + 冷存储 - 最近30天的构建记录保存在PostgreSQL主数据库实现快速访问，超过30天的记录自动归档到对象存储（S3或兼容服务），用户访问历史记录时按需加载，平衡成本和体验
- Q: Agent拟人化的角色性格设定 - 角色性格直接影响用户的情感连接和产品趣味性。应该采用严肃专业型、专业友好型、活泼助手型还是极客伙伴型？ → A: 专业友好型(B) - Agent使用专业但温暖的语言,偶尔使用鼓励性表达(如"正在为您设计数据库..."、"太棒了,UI组件已就绪!"),适度使用✓等简洁符号,既保持可靠感又增加温度,避免过度娱乐化影响严肃工作场景
- Q: 决策卡片的交互展现模式 - 决策卡片的交互模式显著影响用户的注意力管理、信息消费效率和工作流畅度。应该采用中心弹窗式、右侧边栏式、混合模式还是嵌入式？ → A: 混合模式(C) - 高重要性决策以轻量toast通知形式在右下角弹出(显示5秒后自动收起到侧边栏),中低重要性决策仅在右侧边栏显示通知点(数字角标),侧边栏提供完整决策时间线供随时查看,平衡"及时通知关键信息"和"不过度打断工作流"
- Q: Agent 失败后的恢复策略和用户控制粒度 - 失败恢复策略直接影响产品可靠性感知和用户信任度。应该全自动恢复、立即暂停等待、智能重试+用户确认还是分级策略？ → A: 智能重试 + 用户确认 - 轻微错误（网络超时、API限流、临时服务不可用）自动重试最多3次（指数退避），关键错误（决策生成失败、依赖服务缺失、数据验证错误）立即暂停构建流程并显示错误详情和建议操作，用户可选择重试、跳过该Agent或终止构建，平衡自动化效率和用户控制权
- Q: 可观测性和用户行为分析策略 - 创新功能的实际效果（用户是否真的关注Agent工作过程、哪些决策最吸引注意力、可视化是否真正提升信任度）需要通过数据验证以指导产品迭代。应该完整行为追踪、最小化埋点、核心指标埋点+隐私优先还是A/B测试驱动？ → A: 核心指标埋点 + 隐私优先 - 收集关键交互指标（决策卡片点击率和展开详情率、Agent卡片交互率、回放功能使用率、主题切换率、专注模式使用率、构建中途放弃率、错误恢复操作选择分布），所有数据在收集时匿名化（移除用户PII），仅进行聚合分析和统计报告，用户可在设置中完全退出数据收集（opt-out），遵守GDPR和隐私法规，支持产品迭代同时尊重用户隐私
- Q: Agent协作关系的可视化布局方式 - Agent协作关系的布局方式影响用户对系统架构的理解深度和界面复杂度。应该采用图形流程图、垂直列表式、双视图切换还是混合嵌入式？ → A: 双视图切换(C) - 默认使用紧凑的垂直列表视图(按启动顺序排列,用简化箭头和缩进表示协作关系),在工具栏提供"切换到图形视图"按钮,点击后进入交互式流程图视图(Agent显示为节点,协作显示为动画连线,支持缩放和拖拽),两种视图实时同步数据,用户可根据"快速查看进度"或"深入理解架构"的需求自由切换

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 查看Agent工作状态和进度 (Priority: P1)

作为产品用户,我希望在使用AI Agent构建应用时,能够实时看到Agent当前正在做什么、完成了多少进度,让我了解系统正在运行且没有卡住。

**Why this priority**: 这是可视化系统的基础功能。用户最关心的是"AI在做什么"和"还需要等多久",这直接影响用户对产品的信任度和耐心。没有这个功能,用户会感到焦虑和不确定。

**Independent Test**: 当用户发起一个应用构建请求后,在界面上能看到每个Agent(如UIAgent、BackendAgent)的当前任务描述和完成百分比,并能看到进度条实时更新。测试完成标志:从0%到100%的进度变化能准确反映实际任务完成情况。

**Acceptance Scenarios**:

1. **Given** 用户已登录并在Dashboard页面, **When** 用户点击"创建新应用"并输入需求描述, **Then** 系统应显示一个进度可视化面板,列出所有参与的Agent及其初始状态(待启动/准备中)
2. **Given** Agent开始执行任务, **When** 任务进行中, **Then** 对应Agent的状态更新为"进行中",显示当前任务名称(如"正在设计数据库schema")和实时进度百分比(如35%)
3. **Given** 某个Agent完成任务, **When** 任务状态变为已完成, **Then** 该Agent的进度条填满至100%,状态标记为"已完成"并显示完成时间
4. **Given** 整个构建过程完成, **When** 所有Agent都完成任务, **Then** 系统显示总体成功消息和总耗时统计

---

### User Story 2 - 查看Agent决策推理过程 (Priority: P2)

作为产品用户,我希望看到AI Agent为什么做出某个决策,例如为什么选择了某个UI组件、为什么采用某种数据库结构,让我理解AI的思考逻辑并建立信任。

**Why this priority**: 这是"透明化AI决策"的核心体验。用户不仅想知道"做了什么",还想知道"为什么这样做"。这能显著提升用户对AI的信任度,并帮助用户学习和验证AI的决策质量。

**Independent Test**: 在Agent工作过程中,当Agent做出关键决策时(如选择React作为前端框架),系统弹出一张决策卡片,展示决策内容、理由、考虑的备选方案、以及对项目的影响。用户可以点击查看详情或关闭卡片继续观察。

**Acceptance Scenarios**:

1. **Given** Agent正在执行任务并遇到需要决策的节点(如技术选型), **When** Agent做出决策, **Then** 界面上弹出一张半透明决策卡片,显示决策标题、简要理由(1-2句话)和"查看详情"按钮
2. **Given** 决策卡片已弹出, **When** 用户点击"查看详情", **Then** 展开完整决策卡片,显示: (1)决策内容 (2)决策理由(3-5条要点) (3)考虑的备选方案(2-3个) (4)选择该方案的优势和权衡
3. **Given** 用户正在查看决策卡片, **When** 用户点击关闭或点击卡片外区域, **Then** 卡片收起或消失,不影响继续观察其他Agent的工作
4. **Given** 构建过程中产生了多个决策, **When** 用户查看历史决策记录, **Then** 系统提供一个"决策时间线"视图,按时间顺序列出所有决策卡片,用户可以回顾和展开任意历史决策

---

### User Story 3 - Agent拟人化交互体验 (Priority: P3)

作为产品用户,我希望看到Agent像真实团队成员一样协作,带有个性化头像、状态消息(如"正在思考中..."、"已完成任务!")和简单的动画效果,让产品使用体验更生动有趣。

**Why this priority**: 这是增强用户情感连接和趣味性的功能。虽然不影响核心功能,但能让产品从"工具"变成"有温度的助手",显著提升用户满意度和口碑传播。这是差异化竞争的亮点。

**Independent Test**: 在Agent工作过程中,每个Agent显示为一个拟人化卡片,包含: 头像图标、Agent名称、当前状态文本(如"UIAgent正在选择组件库...")、简单的脉动或移动动画(工作时)。用户能感受到Agent像团队成员一样在"活跃工作"。

**Acceptance Scenarios**:

1. **Given** Agent开始工作, **When** Agent状态变为"进行中", **Then** Agent卡片显示拟人化状态消息(如"DatabaseAgent正在设计表结构..."),并且头像图标带有轻微的脉动动画效果
2. **Given** Agent完成一个里程碑任务, **When** 任务达到关键节点, **Then** Agent卡片显示庆祝动画(如短暂的缩放或闪光效果)和成功消息(如"太棒了!API接口已就绪")
3. **Given** 多个Agent在并行工作, **When** 用户查看可视化面板, **Then** 不同Agent卡片在空间上分布合理,彼此间可能有连线或箭头表示协作关系(如BackendAgent的输出传递给DeploymentAgent)
4. **Given** Agent遇到需要等待的情况(如等待外部API响应), **When** Agent进入等待状态, **Then** Agent卡片显示等待动画(如旋转的加载图标)和状态文本(如"正在等待数据库连接...")

---

### User Story 4 - 实时影响预测和预览 (Priority: P2)

作为产品用户,我希望在Agent做出决策前或决策后,能够看到该决策对最终应用的影响预测或预览效果,例如选择某个UI组件后立即看到界面预览,让我能提前判断结果是否符合预期。

**Why this priority**: 这能让用户从"被动观察者"变成"有判断力的参与者"。用户可以在构建过程中就发现问题,而不是等到最后才发现不满意,从而减少返工和提升满意度。

**Independent Test**: 当UIAgent选择了某个UI组件或布局方案时,在决策卡片旁边或下方显示一个小型预览窗口,展示该组件在应用中的样子(可以是静态截图或简单的交互预览)。用户可以放大预览或关闭预览。

**Acceptance Scenarios**:

1. **Given** UIAgent做出UI设计决策(如选择导航栏样式), **When** 决策卡片弹出, **Then** 卡片下方或侧边显示一个预览区域,展示该导航栏的视觉效果(颜色、布局、按钮样式)
2. **Given** 预览区域已显示, **When** 用户点击预览区域, **Then** 预览放大为全屏模态窗口,允许用户更清晰地查看细节或进行简单的交互(如点击按钮看效果)
3. **Given** BackendAgent创建了API接口, **When** 决策卡片显示API设计, **Then** 预览区域显示API的请求/响应示例或数据流图,帮助用户理解接口的作用和数据结构
4. **Given** 用户查看某个影响较大的决策, **When** 决策涉及多个方面(如数据库+API+UI), **Then** 系统显示一个影响图谱,用连线和标注展示该决策如何影响不同模块和最终用户体验

---

### User Story 5 - Agent协作过程可视化 (Priority: P3)

作为产品用户,我希望看到不同Agent之间如何协作和传递信息,例如DatabaseAgent完成schema设计后将结果传递给BackendAgent,让我理解整个系统的工作流程和依赖关系。

**Why this priority**: 这能帮助用户建立对整个系统架构的心智模型,理解"为什么需要这些Agent"和"它们如何配合工作"。对于技术用户或好奇心强的用户,这是很有价值的学习体验。

**Independent Test**: 在可视化面板中,不同Agent卡片之间显示连线或数据流动画,当一个Agent完成任务并输出结果时,连线亮起并显示数据流向下一个Agent。用户可以点击连线查看传递的数据内容摘要。

**Acceptance Scenarios**:

1. **Given** DatabaseAgent完成数据库schema设计, **When** 结果输出给BackendAgent, **Then** DatabaseAgent卡片和BackendAgent卡片之间的连线亮起并显示流动动画(如小圆点沿连线移动),连线旁标注"传递: 数据库schema"
2. **Given** 用户看到Agent之间的数据流动, **When** 用户点击连线, **Then** 弹出一个小窗口,显示传递的数据内容摘要(如"包含3个表: users, projects, tasks")和传递时间戳
3. **Given** 多个Agent并行工作且有依赖关系, **When** 某个Agent完成任务触发下游Agent启动, **Then** 系统显示连线从完成的Agent指向新启动的Agent,并在新Agent卡片上标注"等待前置任务完成"或"已收到输入,开始工作"
4. **Given** 整个构建流程完成, **When** 用户查看完整协作流程, **Then** 系统提供一个"流程回放"功能,按时间顺序播放所有Agent的启动、工作、协作和完成过程,用户可以暂停、快进或后退查看

---

### Edge Cases

- **长时间运行任务**: 如果某个Agent的任务预计需要超过5分钟,系统如何避免用户焦虑?(显示预计剩余时间、任务细节、或提供"后台运行"选项)
- **Agent失败或错误**: 如果某个Agent执行失败,可视化界面如何清晰地展示错误信息和建议的下一步操作?(采用智能重试+用户确认策略: 轻微错误如网络超时、API限流自动重试最多3次并显示"正在重试(第X/3次)..."状态，关键错误如决策生成失败、依赖服务缺失立即暂停构建并弹出错误详情卡片，显示错误类型、具体原因、影响范围和建议操作，用户可选择"重试"、"跳过该Agent"或"终止构建"，界面用红色警告标记失败的Agent并保留完整错误日志供查看)
- **网络中断**: 如果用户网络中断导致WebSocket连接断开,重新连接后如何恢复进度显示?(自动重连、从服务器拉取最新状态、显示"已恢复连接"提示)
- **并发任务过多**: 如果有超过10个Agent同时工作,界面如何保持清晰不混乱?(使用折叠/展开分组、优先显示关键Agent、提供列表视图和图形视图切换)
- **移动设备适配**: 在小屏幕设备上,复杂的可视化界面如何保持可用性?(简化视图、单列布局、滑动查看不同Agent、折叠非关键信息)
- **决策卡片过多**: 如果构建过程中产生几十个决策卡片,如何避免信息过载?(默认只显示关键决策、提供过滤和搜索功能、按重要性分级显示)
- **实时数据延迟**: 如果服务器发送状态更新的频率过高或过低,如何保证用户体验流畅?(采用混合更新频率策略,根据Agent优先级和事件类型动态调整推送间隔: 高优先级Agent 200-500ms、低优先级Agent 1-2s、关键决策<100ms;客户端节流处理、智能合并连续更新)
- **历史记录存储**: 用户关闭页面后再次打开,如何查看之前构建过程的可视化记录?(采用热数据+冷存储策略: 最近30天记录保存在数据库快速访问,超过30天记录自动归档到对象存储按需加载,用户可通过历史记录列表查询和回放任何时期的构建过程,访问归档记录时显示加载提示)

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须实时跟踪所有Agent的工作状态,包括待启动、进行中、已完成、失败四种状态
- **FR-002**: 系统必须计算并显示每个Agent任务的完成进度百分比,精确到1%粒度
- **FR-003**: 系统必须在Agent做出关键决策时生成决策记录,包含决策内容、理由、备选方案和影响说明
- **FR-004**: 系统必须通过WebSocket实时推送Agent状态更新到前端,采用混合更新频率策略: 高优先级Agent(UIAgent、BackendAgent、DatabaseAgent)状态变化推送延迟200-500ms,低优先级Agent(DeploymentAgent、IntegrationAgent)推送延迟1-2s,关键决策事件立即推送(延迟<100ms)
- **FR-005**: 系统必须为每个Agent类型提供拟人化属性,包括名称、头像图标、状态消息模板。状态消息遵循"专业友好型"性格设定: 使用专业但温暖的语言(如"正在为您设计数据库..."而非冷淡的"执行数据库设计任务"),在完成关键里程碑时使用鼓励性表达(如"太棒了,UI组件已就绪!"而非"任务完成"),适度使用✓✗⏳等简洁符号增强可读性,避免过度娱乐化(禁止频繁emoji或口语化俚语)
- **FR-006**: 用户必须能够查看Agent的当前任务描述(纯文本,50-200字符),例如"正在分析用户需求生成UI组件列表"
- **FR-007**: 系统必须采用混合模式展示决策卡片: (1)高重要性决策产生时,在屏幕右下角以toast通知形式弹出,显示决策标题和简要理由(1-2句话),显示5秒后自动收起到右侧边栏; (2)中低重要性决策不弹出通知,仅在右侧边栏增加通知点(数字角标显示未读数量); (3)右侧边栏提供完整决策时间线,按时间倒序列出所有决策(最新在上),用户可点击任意决策查看完整详情(决策内容、理由要点、备选方案、优势权衡、影响说明、关联预览),未读决策用蓝色圆点标记
- **FR-008**: 系统必须提供双视图模式展示Agent协作关系: (1)默认"列表视图" - Agent按启动顺序垂直排列,使用缩进和简化箭头(→)表示数据流向,协作事件在源Agent和目标Agent之间显示为连接标注(如"传递: 数据库schema"); (2)"图形视图" - Agent显示为卡片节点,协作关系显示为动画连线(数据流动时显示沿连线移动的小圆点),支持缩放(滚轮)和拖拽节点调整布局,连线上标注传递的数据类型; (3)工具栏提供视图切换按钮(列表图标⇌图形图标),两种视图实时同步数据和状态更新; (4)系统必须记录所有协作事件包括源Agent、目标Agent、传递内容摘要、数据类型和时间戳
- **FR-009**: 系统必须在UI设计类决策中提供视觉预览,支持静态图片或简单HTML预览
- **FR-010**: 系统必须持久化完整的构建过程事件日志,采用热数据+冷存储策略: 最近30天的记录保存在PostgreSQL主数据库(热数据),超过30天的记录自动归档到对象存储如S3(冷数据),支持用户在任何时间回放历史构建过程(冷数据按需加载,加载时间可能较长)
- **FR-011**: 用户必须能够暂停查看当前可视化状态而不中断后台Agent工作(界面冻结功能)
- **FR-012**: 系统必须检测WebSocket连接状态,在连接中断时显示警告并尝试自动重连
- **FR-013**: 系统必须对决策进行重要性分级(高/中/低),并在界面上通过视觉差异区分(如颜色、大小、位置)
- **FR-014**: 用户必须能够管理决策通知显示: (1)点击右下角toast通知上的关闭按钮(X图标)可立即关闭通知,决策自动标记为已读并保留在侧边栏; (2)点击toast通知本体可展开完整决策详情(在侧边栏或模态窗口中),同时toast消失; (3)用户可点击侧边栏中的"全部标为已读"按钮清除所有未读标记,不影响决策记录的保留; (4)用户可在设置中关闭高重要性决策的toast通知(改为仅在侧边栏显示),适合希望完全不被打断的场景
- **FR-015**: 系统必须在Agent失败时采用智能重试+用户确认策略: (1)将错误分类为"轻微错误"(网络超时、API限流、临时服务不可用)和"关键错误"(决策生成失败、依赖服务缺失、数据验证错误); (2)轻微错误自动重试最多3次,采用指数退避策略(1s, 2s, 4s间隔),界面显示"正在重试(第X/3次)..."状态; (3)关键错误或重试3次后仍失败,立即暂停构建流程,Agent卡片显示红色警告标记,弹出错误详情卡片包含错误类型、具体原因、影响范围和建议操作; (4)用户可选择"重试"(从失败点继续)、"跳过该Agent"(标记为已跳过,继续其他Agent)或"终止构建"(停止所有Agent并保存当前进度)
- **FR-023**: 系统必须记录所有Agent错误和重试历史,包括错误类型、错误消息、堆栈跟踪(技术细节)、发生时间、重试次数、用户选择的操作。错误记录作为构建会话的一部分持久化,用户可在回放时查看完整错误日志
- **FR-016**: 系统必须提供整体构建进度的汇总视图,显示已完成Agent数量/总Agent数量和总体完成百分比
- **FR-017**: 系统必须支持响应式布局,在桌面、平板、手机三种屏幕尺寸上都能正常显示核心信息
- **FR-018**: 用户必须能够访问历史构建记录列表(包括热数据和冷数据),选择任意历史记录进行查看或回放。访问30天内记录响应时间<500ms,访问归档记录(>30天)响应时间<3s(从对象存储加载)并显示加载提示
- **FR-022**: 系统必须提供自动数据归档后台任务,每日检查并将超过30天的构建会话记录(包括决策记录、协作事件、Agent状态快照)归档到对象存储,归档后从主数据库删除详细事件数据但保留会话元数据(会话ID、用户ID、项目ID、开始/结束时间、状态)用于快速列表查询
- **FR-019**: 系统必须在Agent工作状态变化时触发视觉动画效果(如脉动、闪烁、颜色变化),增强感知
- **FR-020**: 系统必须提供"专注模式"选项,用户可以选择只查看关键Agent或关键决策,隐藏次要信息
- **FR-021**: 系统必须提供设计主题切换功能,默认使用"温暖友好风"主题(明亮色彩、圆角卡片、趣味插画、跳跃动画),并支持切换到"科技未来感"主题(深色背景、霓虹色点缀、流畅粒子动画、玻璃态效果),主题偏好持久化保存
- **FR-024**: 系统必须收集核心用户交互指标以支持产品迭代,包括: (1)决策卡片点击率(点击查看详情的用户占比)和展开详情率(展开完整决策信息的次数/决策总数); (2)Agent卡片交互率(点击、悬停查看Agent详情的用户占比); (3)回放功能使用率(使用历史回放的用户占比和平均回放次数); (4)主题切换率(切换主题的用户占比); (5)专注模式使用率(启用专注模式的用户占比和使用时长); (6)构建中途放弃率(未完成构建就离开的会话占比); (7)错误恢复操作选择分布(重试/跳过/终止的选择比例)
- **FR-025**: 系统必须在数据收集时确保用户隐私保护: (1)所有收集的数据在客户端发送前匿名化,移除用户PII(姓名、邮箱、IP地址等); (2)仅收集聚合统计指标,不记录个人级别的详细行为轨迹; (3)数据传输使用HTTPS加密; (4)在用户设置中提供"数据收集与隐私"选项,清晰说明收集的数据类型和用途,提供完全退出(opt-out)选项; (5)遵守GDPR、CCPA等隐私法规要求; (6)定期生成数据收集透明度报告供用户查阅
- **FR-026**: 系统必须提供产品分析仪表板(仅供产品团队内部访问),展示聚合分析结果包括: (1)各项指标的总体统计(均值、中位数、分布); (2)按时间趋势分析(日/周/月维度); (3)不同用户群体的对比分析(新用户vs老用户、不同主题偏好用户等); (4)异常检测(如某指标突然下降的预警)。所有分析基于匿名化聚合数据,不展示任何可识别个人的信息

### Key Entities

- **Agent工作状态 (AgentWorkStatus)**: 表示单个Agent在某个时间点的工作状态,包括Agent ID、Agent类型(UIAgent/BackendAgent等)、当前状态(待启动/进行中/已完成/失败/重试中/已跳过)、当前任务描述、进度百分比、开始时间、结束时间、重试计数(当前重试次数/最大重试次数)、最后错误信息(如果有)。用于实时跟踪和显示Agent工作进度及错误恢复状态。

- **Agent错误记录 (AgentErrorRecord)**: 表示Agent执行过程中发生的错误,包括错误ID、所属Agent ID、错误类型(轻微错误/关键错误)、错误分类(网络超时/API限流/决策生成失败/依赖服务缺失/数据验证错误等)、错误消息(用户可读)、技术详情(堆栈跟踪等)、发生时间、重试次数、最终处理方式(自动重试成功/用户选择重试/用户选择跳过/用户选择终止)。用于错误追踪和构建过程回放时展示完整错误历史。

- **决策记录 (DecisionRecord)**: 表示Agent做出的一个决策,包括决策ID、所属Agent ID、决策标题、决策内容、决策理由(多条要点)、考虑的备选方案列表、选择该方案的优势和权衡、重要性级别(高/中/低)、决策时间戳、关联的预览数据(如UI截图URL或API示例)。用于透明化AI决策过程。

- **协作事件 (CollaborationEvent)**: 表示Agent之间的协作和数据传递,包括事件ID、源Agent ID、目标Agent ID、传递的数据内容摘要(文本)、数据类型(如schema/API定义/UI配置)、传递时间戳。用于可视化Agent协作流程。

- **构建会话 (BuildSession)**: 表示一次完整的应用构建过程,包括会话ID、用户ID、项目ID、开始时间、结束时间、总体状态(进行中/成功/失败/部分成功)、参与的Agent列表、生成的决策记录列表、协作事件列表、错误记录列表、归档状态(热数据/已归档)、归档时间戳、对象存储路径(归档时使用)。用于持久化和回放构建过程,支持热数据和冷数据的生命周期管理,包含完整的错误和恢复历史。

- **Agent拟人化配置 (AgentPersona)**: 表示每个Agent类型的拟人化属性,包括Agent类型标识、显示名称(如"UI设计师")、头像图标URL、状态消息模板(如"{agent_name}正在{task_description}")、默认颜色主题、更新频率优先级(高/低,用于确定WebSocket推送间隔)。用于增强用户情感连接和控制实时更新策略。

- **预览数据 (PreviewData)**: 表示决策的可视化预览内容,包括预览ID、关联的决策ID、预览类型(静态图片/HTML片段/JSON数据)、预览内容(URL或内联数据)、预览标题和描述。用于让用户提前判断决策效果。

- **用户交互指标事件 (UserInteractionMetricEvent)**: 表示一次匿名化的用户交互指标记录,包括事件ID、事件类型(决策卡片点击/Agent卡片交互/回放使用/主题切换/专注模式切换/构建放弃/错误恢复操作)、事件时间戳、匿名会话ID(不关联到具体用户)、相关上下文(如决策重要性级别、Agent类型、操作选择等,不含PII)、用户是否选择加入数据收集(opt-in状态)。用于产品分析和迭代决策,所有数据匿名化且仅用于聚合统计。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户在应用构建过程中,能够持续看到Agent状态更新,任何Agent状态变化都能在1秒内反映到界面上
- **SC-002**: 用户能够在构建完成后回顾至少80%的关键决策(重要性为高或中的决策),并理解每个决策的理由
- **SC-003**: 90%的用户在首次使用可视化功能后,能够准确描述"当前有哪些Agent在工作"和"它们在做什么"
- **SC-004**: 用户对产品透明度和信任度的满意度评分(5分制)平均达到4.2分以上(相比无可视化功能时提升至少1分)
- **SC-005**: 在构建过程中,用户因"不知道系统在做什么"而中途放弃或刷新页面的比例低于5%
- **SC-006**: 系统能够支持同时显示最多10个并行工作的Agent,界面保持清晰可读,不出现严重的性能卡顿(帧率保持在30fps以上)
- **SC-007**: 用户点击查看决策详情或预览时,响应时间在500ms以内,不影响流畅体验
- **SC-008**: 在移动设备上,核心可视化功能(Agent状态、进度条、决策卡片)能够正常显示和交互,用户任务完成率不低于桌面版的85%
- **SC-009**: 系统在WebSocket连接中断后,能够在10秒内自动重连并恢复状态同步,用户无需手动刷新页面
- **SC-010**: 用户能够在3次点击内访问任何历史构建记录并开始回放,回放功能使用率达到至少20%(即20%的用户会主动回放历史记录)
- **SC-011**: 决策卡片的"查看详情"点击率达到40%以上(即用户对决策透明度有强烈兴趣)
- **SC-012**: 用户对拟人化交互体验(Agent头像、状态消息、动画)的喜爱度评分(5分制)平均达到4.0分以上

## Assumptions *(optional)*

- **假设1**: 用户主要使用现代桌面浏览器(Chrome/Firefox/Safari/Edge最新版本),支持WebSocket和CSS动画
- **假设2**: 平均构建过程涉及3-6个Agent,每个Agent执行1-3个关键决策,总构建时间在2-10分钟之间
- **假设3**: 用户对"可视化"有基本的理解和期待,熟悉进度条、状态指示器等常见UI元素
- **假设4**: 后端Agent系统已经能够主动上报工作状态、进度和决策信息,并通过WebSocket推送到前端
- **假设5**: UI设计决策的预览可以通过截图或简单的HTML片段实现,不需要完整的交互式原型
- **假设6**: 用户网络环境基本稳定,偶尔的短暂中断(5-10秒)可以通过自动重连恢复
- **假设7**: 数据库能够高效存储最近30天的构建记录(估计最多1000-5000次构建),对象存储服务(S3或兼容服务)可用于归档历史数据,归档数据的加载时间在3秒内可接受
- **假设8**: 移动端用户占比约20%-30%,因此移动适配是重要但非最高优先级的需求
- **假设9**: 大部分用户愿意参与匿名化的产品数据收集以帮助改进产品体验,但也有部分用户会选择退出(opt-out),预计退出率在10-20%之间

## Constraints *(optional)*

- **技术约束**: 可视化功能必须基于现有的WebSocket架构(Socket.IO),不能引入新的实时通信协议
- **性能约束**: 前端可视化渲染不能显著增加CPU和内存占用,在低端设备上也应保持基本可用(降级显示)
- **数据约束**: 单次构建会话的事件日志大小应控制在5MB以内,避免存储和传输压力。热数据(最近30天)保存在PostgreSQL主数据库,冷数据自动归档到对象存储(S3或兼容服务),归档后从主数据库删除详细事件数据但保留会话元数据。对象存储成本按需评估,预估每月新增归档数据约1-5GB
- **时间约束**: P1功能(Agent工作状态和进度可视化)必须在第一个迭代中完成,P2和P3功能可以分阶段迭代
- **兼容性约束**: 可视化组件必须与现有的Dashboard、Builder页面风格保持一致,使用Tailwind CSS和现有的设计系统
- **可访问性约束**: 关键信息(Agent状态、进度)不能仅依赖颜色区分,需要提供文本或图标辅助(为色盲用户考虑)
- **隐私与合规约束**: 用户交互指标收集必须严格遵守GDPR、CCPA等隐私法规。所有收集的数据必须在客户端匿名化,不得包含任何PII(个人身份信息)。必须提供用户可随时访问的隐私设置和opt-out选项。数据仅用于产品改进和聚合分析,不得用于广告投放或第三方销售。数据保留期限不超过12个月,超期数据自动删除

## Out of Scope *(optional)*

- **用户主动干预Agent决策**: 本功能仅提供观察和理解,不支持用户在构建过程中手动修改或否决Agent的决策(未来功能)
- **Agent性能指标和优化建议**: 不包括分析Agent执行效率、提供性能优化建议等高级功能
- **多用户协作可视化**: 不支持多个用户同时观察同一个构建过程并实时交流(如聊天功能)
- **Agent"思考"的动画化表现**: 不包括将Agent的内部推理过程(如LLM的token生成)逐字逐句可视化,仅展示最终决策结果
- **自定义可视化布局**: 用户不能自定义Agent卡片的位置、大小或连线样式,使用系统预设的布局算法
- **导出可视化报告**: 不支持将可视化过程导出为PDF、视频或其他格式的报告(未来功能)
- **第三方集成**: 不包括将可视化数据同步到外部监控工具或BI平台
- **个人级用户行为追踪**: 不收集可识别个人的详细行为轨迹(如鼠标移动轨迹、完整的键盘输入记录、精确的页面停留时长等)。不进行用户画像构建、不进行跨产品/跨设备的用户追踪、不使用第三方广告/分析SDK(如Google Analytics完整版、Facebook Pixel等)
- **A/B测试和实验平台**: 初始版本不包括完整的A/B测试基础设施,不同用户看到相同的可视化体验。未来可能基于数据分析结果进行迭代优化,但不会在初始版本中实施实验性功能分发
